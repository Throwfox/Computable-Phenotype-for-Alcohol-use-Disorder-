import pandas as pd
import duckdb

data_path= '/media/volume/GLP/RDRP_6263_AUD/'
results_path= 'results/'

concept_ids=[21604824,1714319,21604821,36224129,43144973,
                   40035385,41207533,40035384,36224128,35153127,
                   35146298,43285339,43258147,43515471,43517504,
                   43144974,19119755,40891778,735888,36261679,
                   19091004,19020355,735887,21063869,735889,
                   19109625,35139262,35147068,41297197,19109624,
                   44053196,735850,36232732,36232731,21604823,19043959
                  ]
drug_concept_ids=[40175986, 40175987, 21136574, 21097352, 21126678, 21038472, 21067968, 35776577, 21048283, 35776576, 21107214, 40718186, 21048284, 21147793, 35786437, 21177278, 35787000, 45774486, 45774490, 40221196, 40221202, 40221205, 40221207, 40221211, 40221213, 40221217, 40221219, 40221223, 40221225, 40221229, 40221231, 44032035, 44056444, 44116733, 44072381, 44087399, 44068644, 40166392, 40166393, 40166395, 40166396, 40166398, 40166399, 40166400, 40166401, 40166403, 40166404, 40166407, 40166408, 19043959, 43173470, 43151289, 2913258, 35153512, 42926803, 36270062, 36258299, 36260834, 36263458, 36265950, 36263819, 36270061, 36259808, 43184316, 43173471, 43206241, 43162465, 43206240, 36923624, 36937358, 42479897, 41138532, 41325354, 36954495, 41232109, 40888603, 41107079, 41294027, 42482981, 42480083, 41232108, 41232111, 41075638, 40857293, 36036540, 42478773, 43276391, 40944467, 41262846, 41107080, 41232110, 40919585, 41325357, 41044253, 41201040, 41138533, 41194551, 41169648, 42480102, 42482943, 42481897, 40720427, 42480023, 42479357, 42479940, 42483048, 41138529, 41325358, 42478902, 40857294, 41075640, 40919584, 40888604, 36782119, 41044254, 40950731, 41325356, 41037879, 995235, 37593558, 37593559, 42479906, 42481178, 42479956, 42478903, 44077949, 40720428, 42481801, 42481140, 2913257, 2913250, 2913256, 2913249, 2913255, 2913254, 2913253, 2913252, 2913251, 21173834, 40720429, 21046176, 36060197, 36060196, 36060194, 40720430, 36060195, 40720431, 36942196, 2913246, 2913245, 43162464, 2913235, 2913236, 2913237, 40838793, 2913244, 40932065, 2913243, 2913242, 21046173, 2913241, 40720432, 21105078, 21114878, 21055950, 21046174, 21046175, 2913240, 40932064, 2913239, 2913238, 40720433, 21095219, 2913247, 2913248, 36060201, 21036332, 36060200, 36060198, 40720434, 36060199, 40720435, 21154240, 36955382, 21036331, 36881894, 43173473, 43151290, 43195333, 43173474, 43173475, 36782116, 36782113, 36782112, 36782115, 36782114, 42926802, 36782117, 43173472, 43037305, 43163534, 43037304, 36782118, 2043888, 41213550, 41131902, 41100598, 44160493, 41325355, 41169647, 44171832, 41262844, 40888602, 40981880, 40981881, 41325353, 41138528, 41256510, 44164293, 44183045, 41262845, 41075641, 41013149, 40950730, 41138531, 40950729, 41037880, 44171831, 41194550, 41138530, 44175549, 44168091, 41294028, 40950728, 44168092, 44160494, 40919583, 41075639, 41037878, 35138666, 41056863, 40838792, 41088345, 41056864, 40994582, 19043960, 19082217, 19043981, 19043982, 36272064, 36259500, 40153276, 43173469, 40153277, 42614834, 2913259, 36893468, 43195332, 36782120, 42926804, 36221672, 41018004, 40895951, 35147256, 36221673, 21604823, 36232731, 36232732, 42683527, 42683526, 45774485, 45774489, 40747737, 36249045, 36249046, 40747736, 42683525, 42683523, 42683522, 42683520, 42683524, 2918163, 2918164, 40747735, 40747733, 40747732, 36810455, 40747734, 36813866, 40747731, 2918165, 45774488, 45774491, 45774492, 36234798, 36234799, 36249047, 36249048, 36237170, 36237171, 735850, 44053196, 19109624, 41297197, 19106568, 40823719, 40847110, 41159482, 41283663, 41105285, 41033995, 41148989, 41304368, 40929949, 41148988, 35147068, 35139262, 35157275, 35146876, 19109625, 19106567, 41211512, 41136697, 41086276, 40949096, 735889, 21063869, 43515526, 43514814, 43516426, 43515525, 43269026, 43279897, 43274563, 43258148, 735883, 21044232, 21024601, 21162107, 21034315, 2921869, 21024600, 21083472, 21083473, 21083471, 36064012, 36064013, 35887201, 40737295, 21063870, 21152188, 21162106, 36064014, 36064015, 35887202, 40737296, 735887, 19020355, 735851, 19044538, 21162108, 36958840, 44128489, 44089483, 21103129, 19091004, 36261679, 735886, 36275888, 36260532, 36266477, 36272476, 735888, 40891778, 19119755, 43144974, 735882, 40847111, 41314942, 40940574, 41323603, 41033996, 19044893, 44115304, 43200120, 43144976, 43144977, 43144975, 41148990, 41054708, 41054707, 43517504, 43515471, 43258147, 43285339, 35146298, 35153127, 36224128, 40035384, 41207533, 40035385, 43144973, 36224129, 21604821, 36228117, 36228118, 40166388, 40166389, 36219425, 36219426, 40166394, 40165049, 40165053, 40165057, 40166405, 40166409, 1714319, 40221195, 40221199, 40221193, 40221194, 21037362, 21174852, 21037364, 21135476, 21096268, 21037367, 21037368, 21066849, 21106133, 21066850, 21106134, 21037366, 21174856, 35750698, 21076746, 35771696, 21076749, 1235599, 21096270, 21096271, 1235600, 21037363, 21106130, 40739525, 40739524, 21027605, 21125588, 42949477, 42949474, 42949475, 42949478, 42949476, 42949472, 42949469, 42949470, 2051348, 42949473, 42949471, 36062088, 36062087, 36062086, 36925711, 36942206, 36937886, 36930103, 21076748, 21135480, 21037370, 21135481, 35605492, 35605494, 1714351, 1714372, 36062085, 36062084, 36062083, 36924133, 36952701, 36966521, 36938210, 21115916, 21027604, 21174857, 40739523, 21155302, 21135477, 44041190, 21155299, 42949486, 43677404, 43749000, 35409654, 43210048, 43155283, 43785074, 41265243, 35861564, 21066845, 42949484, 42949487, 42949485, 43166271, 35770935, 35758321, 35763239, 35759029, 43199268, 43210049, 43144128, 35771694, 41061027, 44186000, 41228138, 44178523, 41228137, 44185999, 35746523, 35746524, 35410131, 35412494, 35407059, 43155284, 43144129, 43144130, 43133233, 43177278, 43188231, 40905069, 41092587, 41029843, 41029842, 35745814, 35749997, 35767346, 35750697, 43199269, 43155285, 43199270, 43133232, 35763240, 35767347, 35759030, 43029374, 44186001, 35771695, 35759031, 35746525, 41147463, 40959706, 41302868, 35775806, 35763242, 35763241, 35775808, 35775807, 35759032, 21086512, 21047256, 40739516, 36952445, 21096266, 36509329, 40739517, 36941482, 43767005, 21174855, 44111687, 44101554, 21165111, 21047257, 40977882, 21057008, 40946906, 41197065, 41165702, 40739514, 21027603, 41248690, 41165701, 41071624, 40915538, 41321346, 41134434, 36506883, 37592905, 21125587, 40739515, 21096267, 42949481, 43695221, 43677406, 43677405, 43821137, 36275524, 36257631, 36276550, 43695220, 41248689, 41279465, 40998827, 43605179, 41061028, 40967478, 41197064, 21145359, 21066848, 21125586, 21106132, 42949479, 43274291, 44062965, 44036807, 42949482, 42949480, 21066847, 21086511, 21155300, 21106131, 40739519, 36930286, 36074470, 40884593, 36927682, 41321347, 21115915, 40739520, 21057007, 21047255, 40959705, 43263280, 2918166, 43263281, 41209923, 21174854, 21037365, 21086510, 36509759, 40739521, 36944174, 2918167, 36062082, 43274290, 36963695, 21096265, 40739522, 21135478, 21066846, 43166270, 35757862, 43133231, 35410481, 43155282, 43188230, 41175230, 35770428, 43177277, 40165108, 40165109, 40221198, 40221203, 40221204, 44784869, 44784872, 44784870, 44784871, 40165110, 40166413, 40221206, 40221208, 40221209, 44784873, 44784876, 44784874, 44784875, 40166414, 40221210, 40221212, 40221214, 40221215, 40166415, 40221216, 40221218, 40221220, 40221221, 44784877, 44784881, 44784882, 44784878, 44784879, 44784880, 40221222, 40221224, 40221226, 40221227, 45774484, 40221228, 40221230, 40221232, 40221233, 36212591, 35605493, 35605495, 21106129, 36212592, 21135474, 21145357, 40063517, 21135475, 44056876, 40117295, 42949493, 42949488, 21066844, 42949489, 42949492, 43731065, 43731063, 36264482, 43731064, 41112683, 35861565, 21027602, 42949490, 40063518, 42949494, 42949491, 36212593, 21604824, 36232090, 36232091, 40221200, 40221201, 36239345]

# Initialize DuckDB connection
print('Initializing DuckDB connection...')
con = duckdb.connect(database=':memory:')

# Create drug_concept_ids list as SQL-compatible string
drug_ids_sql = ", ".join(map(str, drug_concept_ids))

print('Loading and processing drug data with DuckDB (efficient for large files)...')
# Query to get AUD drug exposure and count unique drug_concept_ids per person
query = f"""
SELECT 
    person_id,
    COUNT(DISTINCT drug_concept_id) as drug_count
FROM read_csv_auto('{data_path}r6263_drug_exposure.csv')
WHERE drug_concept_id IN ({drug_ids_sql})
GROUP BY person_id
HAVING COUNT(DISTINCT drug_concept_id) >= 1
ORDER BY drug_count DESC
"""

print('Executing query to count unique AUD medications per patient...')
drug_counts = con.execute(query).df()

# Show statistics
print(f"\n{'='*80}")
print(f"Found {len(drug_counts)} patients with AUD medications")
print(f"\nDrug count distribution:")
print(drug_counts['drug_count'].describe())
print(f"\nSample of results (first 10 patients):")
print(drug_counts.head(10))

# Save results
drug_counts.to_csv(f'{results_path}aud_patients_drug_rule.csv', index=False)

# Close DuckDB connection
con.close()

print("\nExtraction complete. Results saved to 22aud_patients_drug_rule.csv")
print(f"All {len(drug_counts)} patients have medication_count >= 1")